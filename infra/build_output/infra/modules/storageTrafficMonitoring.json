{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.5.1644",
      "templateHash": "895828039464727973"
    }
  },
  "parameters": {
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Name of the storage account to monitor"
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Log Analytics workspace"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "alertEmailAddresses": {
      "type": "array",
      "metadata": {
        "description": "Email addresses for alert notifications"
      }
    },
    "egressThresholdGB": {
      "type": "int",
      "defaultValue": 50,
      "metadata": {
        "description": "Threshold for egress data in GB per hour"
      }
    },
    "unusualAccessThreshold": {
      "type": "int",
      "defaultValue": 10,
      "metadata": {
        "description": "Threshold for unusual access patterns (number of unique IPs)"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags for the resources"
      }
    }
  },
  "variables": {
    "$fxv#0": "{\n  \"version\": \"Notebook/1.0\",\n  \"items\": [\n    {\n      \"type\": 1,\n      \"content\": {\n        \"json\": \"# Storage Account Traffic Analysis\\nMonitoring outbound traffic patterns and potential data exfiltration\"\n      },\n      \"name\": \"text - 0\"\n    },\n    {\n      \"type\": 9,\n      \"content\": {\n        \"version\": \"KqlParameterItem/1.0\",\n        \"parameters\": [\n          {\n            \"id\": \"4f8e5ef1-6c5f-4f53-a37f-09a15e1731b6\",\n            \"version\": \"KqlParameterItem/1.0\",\n            \"name\": \"TimeRange\",\n            \"type\": 4,\n            \"isRequired\": true,\n            \"value\": {\n              \"durationMs\": 86400000\n            },\n            \"typeSettings\": {\n              \"selectableValues\": [\n                {\n                  \"durationMs\": 3600000\n                },\n                {\n                  \"durationMs\": 86400000\n                },\n                {\n                  \"durationMs\": 604800000\n                }\n              ]\n            }\n          }\n        ],\n        \"style\": \"pills\",\n        \"queryType\": 0\n      },\n      \"name\": \"parameters - 1\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"StorageBlobLogs\\n| where TimeGenerated > ago({TimeRange})\\n| summarize EgressBytes=sum(ResponseBodySize) by bin(TimeGenerated, 1h)\\n| render timechart\",\n        \"size\": 0,\n        \"title\": \"Egress Traffic Over Time\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"query - 2\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"StorageBlobLogs\\n| where TimeGenerated > ago({TimeRange})\\n| where OperationName in (\\\"GetBlob\\\", \\\"CopyBlob\\\")\\n| summarize TotalEgress=sum(ResponseBodySize), Operations=count() by CallerIpAddress\\n| top 10 by TotalEgress desc\",\n        \"size\": 0,\n        \"title\": \"Top IP Addresses by Egress Volume\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\",\n        \"gridSettings\": {\n          \"formatters\": [\n            {\n              \"columnMatch\": \"TotalEgress\",\n              \"formatter\": 8,\n              \"formatOptions\": {\n                \"min\": 0,\n                \"palette\": \"blue\"\n              }\n            }\n          ]\n        }\n      },\n      \"name\": \"query - 3\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"StorageBlobLogs\\n| where TimeGenerated > ago({TimeRange})\\n| where OperationName in (\\\"GetBlob\\\", \\\"CopyBlob\\\")\\n| summarize EgressBytes=sum(ResponseBodySize) by UserAgentHeader\\n| top 10 by EgressBytes desc\",\n        \"size\": 0,\n        \"title\": \"Top User Agents by Egress Volume\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"query - 4\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"StorageBlobLogs\\n| where TimeGenerated > ago({TimeRange})\\n| where ResponseBodySize > 100000000 // 100MB\\n| project TimeGenerated, CallerIpAddress, UserAgentHeader, BlobUrl, ResponseBodySize\\n| order by ResponseBodySize desc\",\n        \"size\": 0,\n        \"title\": \"Large File Downloads (>100MB)\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"query - 5\"\n    },\n    {\n      \"type\": 3,\n      \"content\": {\n        \"version\": \"KqlItem/1.0\",\n        \"query\": \"StorageBlobLogs\\n| where TimeGenerated > ago({TimeRange})\\n| summarize UniqueIPs=dcount(CallerIpAddress) by bin(TimeGenerated, 1h)\\n| render timechart\",\n        \"size\": 0,\n        \"title\": \"Unique IP Addresses Over Time\",\n        \"queryType\": 0,\n        \"resourceType\": \"microsoft.operationalinsights/workspaces\"\n      },\n      \"name\": \"query - 6\"\n    }\n  ],\n  \"styleSettings\": {\n    \"paddingStyle\": \"wide\"\n  },\n  \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"\n}"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/actionGroups",
      "apiVersion": "2021-09-01",
      "name": "[format('{0}-traffic-monitor-ag', parameters('storageAccountName'))]",
      "location": "global",
      "properties": {
        "copy": [
          {
            "name": "emailReceivers",
            "count": "[length(parameters('alertEmailAddresses'))]",
            "input": {
              "name": "[format('Email {0}', indexOf(parameters('alertEmailAddresses'), parameters('alertEmailAddresses')[copyIndex('emailReceivers')]))]",
              "emailAddress": "[parameters('alertEmailAddresses')[copyIndex('emailReceivers')]]",
              "useCommonAlertSchema": true
            }
          }
        ],
        "groupShortName": "StgTraffic",
        "enabled": true
      }
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
      "name": "[format('{0}-traffic-diag', parameters('storageAccountName'))]",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
        "metrics": [
          {
            "category": "Transaction",
            "enabled": true,
            "retentionPolicy": {
              "enabled": true,
              "days": 30
            }
          }
        ],
        "logs": [
          {
            "category": "StorageRead",
            "enabled": true
          },
          {
            "category": "StorageWrite",
            "enabled": true
          },
          {
            "category": "StorageDelete",
            "enabled": true
          }
        ]
      }
    },
    {
      "type": "Microsoft.Insights/metricAlerts",
      "apiVersion": "2018-03-01",
      "name": "[format('{0}-egress-volume-alert', parameters('storageAccountName'))]",
      "location": "global",
      "properties": {
        "description": "Alert when egress traffic volume exceeds threshold",
        "severity": 2,
        "enabled": true,
        "scopes": [
          "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
        ],
        "evaluationFrequency": "PT1H",
        "windowSize": "PT1H",
        "criteria": {
          "odata.type": "Microsoft.Azure.Monitor.SingleResourceMultipleMetricCriteria",
          "allOf": [
            {
              "name": "EgressVolume",
              "metricNamespace": "Microsoft.Storage/storageAccounts",
              "metricName": "Egress",
              "operator": "GreaterThan",
              "threshold": "[mul(parameters('egressThresholdGB'), 1000000000)]",
              "timeAggregation": "Total",
              "criterionType": "StaticThresholdCriterion"
            }
          ]
        },
        "actions": [
          {
            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}-unusual-access-alert', parameters('storageAccountName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "Storage Unusual Access Pattern Alert",
        "description": "Alert when storage account accessed from unusual number of IP addresses",
        "severity": 2,
        "enabled": true,
        "evaluationFrequency": "PT1H",
        "windowSize": "PT1H",
        "criteria": {
          "allOf": [
            {
              "query": "StorageBlobLogs\n| where TimeGenerated > ago(1h)\n| summarize dcount(CallerIpAddress) by bin(TimeGenerated, 1h)\n| where dcount_CallerIpAddress > ${unusualAccessThreshold}\n",
              "timeAggregation": "Count",
              "operator": "GreaterThan",
              "threshold": 0,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "actions": {
          "actionGroups": [
            "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/scheduledQueryRules",
      "apiVersion": "2021-08-01",
      "name": "[format('{0}-large-downloads-alert', parameters('storageAccountName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "Storage Large File Downloads Alert",
        "description": "Alert when large files are downloaded from storage",
        "severity": 2,
        "enabled": true,
        "evaluationFrequency": "PT1H",
        "windowSize": "PT1H",
        "criteria": {
          "allOf": [
            {
              "query": "StorageBlobLogs\n| where OperationName in (\"GetBlob\")\n| where ResponseBodySize > 100000000 // 100MB\n| summarize TotalDownloads=count(), TotalBytes=sum(ResponseBodySize), IPAddresses=make_set(CallerIpAddress) by BlobUrl\n| where TotalBytes > 1000000000 // 1GB\n",
              "timeAggregation": "Count",
              "operator": "GreaterThan",
              "threshold": 0,
              "failingPeriods": {
                "numberOfEvaluationPeriods": 1,
                "minFailingPeriodsToAlert": 1
              }
            }
          ]
        },
        "actions": {
          "actionGroups": [
            "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
      ]
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "apiVersion": "2021-08-01",
      "name": "[guid(format('{0}-traffic-workbook', parameters('storageAccountName')))]",
      "location": "[parameters('location')]",
      "kind": "shared",
      "properties": {
        "displayName": "[format('{0} Traffic Analysis', parameters('storageAccountName'))]",
        "serializedData": "[variables('$fxv#0')]",
        "sourceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "category": "storageInsights",
        "version": "1.0"
      }
    }
  ],
  "outputs": {
    "actionGroupId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Insights/actionGroups', format('{0}-traffic-monitor-ag', parameters('storageAccountName')))]"
    },
    "workbookId": {
      "type": "string",
      "value": "[guid(format('{0}-traffic-workbook', parameters('storageAccountName')))]"
    }
  }
}