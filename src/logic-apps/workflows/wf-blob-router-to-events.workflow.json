{
  "definition":{
    "$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
      "ingressQueue":{"type":"string","defaultValue":"@appsetting('INGRESS_QUEUE_NAME')"}
    },
    "triggers":{
      "from_ingress":{
        "type":"ApiConnection",
        "inputs":{
          "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
          "path":"/onnewmessage","method":"get",
          "queries":{"queueName":"@parameters('ingressQueue')","queueVisibilityTimeout":"PT5M"}
        },
        "splitOn":"@triggerBody()?['QueueMessagesList']?['QueueMessage']"
      }
    },
    "actions":{
      "parse_eg":{
        "type":"Compose",
        "inputs":"@json(base64ToString(triggerOutputs()['body']['QueueMessagesList']['QueueMessage']['MessageText']))"
      },
      "map_to_canonical":{
        "type":"Compose",
        "runAfter":{"parse_eg":["Succeeded"]},
        "inputs":{
          "pipelineName":"pl_ingest_raw",
          "parameters":{
            "Path":"@concat(outputs('parse_eg')?[0]?['data']?['url'])",
            "pathPrefix":"@coalesce(outputs('parse_eg')?[0]?['subject'],'')",
            "EventType":"@coalesce(outputs('parse_eg')?[0]?['eventType'],'')"
          },
          "messageId":"@coalesce(outputs('parse_eg')?[0]?['id'], guid())"
        }
      },
      "enqueue":{
        "type":"ApiConnection",
        "inputs":{
          "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
          "path":"/putmessage","method":"post",
          "body":{"queueName":"@appsetting('EVENT_QUEUE_NAME')","content":"@base64(string(outputs('map_to_canonical')))"}
        }
      }
    },
    "outputs":{}
  },
  "kind":"Stateful",
  "connections":{
    "azurequeues":{
      "connectionId":"/subscriptions/@appsetting('WORKFLOWS_SUBSCRIPTION_ID')/resourceGroups/@appsetting('WORKFLOWS_RESOURCE_GROUP_NAME')/providers/Microsoft.Web/connections/azurequeues",
      "connectionName":"azurequeues",
      "id":"/subscriptions/@appsetting('WORKFLOWS_SUBSCRIPTION_ID')/providers/Microsoft.Web/locations/@{workflow().location}/managedApis/azurequeues"
    }
  }
}