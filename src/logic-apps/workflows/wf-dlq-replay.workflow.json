{
  "definition":{
    "$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
      "mode":{"type":"string","defaultValue":"requeue","allowedValues":["requeue","direct"]},
      "maxMessages":{"type":"int","defaultValue":50},
      "maxRetries":{"type":"int","defaultValue":5},
      "eventQueue":{"type":"string","defaultValue":"@appsetting('EVENT_QUEUE_NAME')"},
      "dlqName":{"type":"string","defaultValue":"@appsetting('DLQ_NAME')"},
      "poisonQueue":{"type":"string","defaultValue":"@coalesce(appsetting('POISON_QUEUE_NAME'),'events-synapse-poison')"},
      "subscriptionId":{"type":"string","defaultValue":"@appsetting('WORKFLOWS_SUBSCRIPTION_ID')"},
      "resourceGroup":{"type":"string","defaultValue":"@appsetting('WORKFLOWS_RESOURCE_GROUP_NAME')"},
      "synapseWorkspace":{"type":"string","defaultValue":"@appsetting('SYNAPSE_WORKSPACE')"}
    },
    "triggers":{"manual":{"type":"Request","kind":"Http","inputs":{"schema":{"type":"object"}}}},
    "actions":{
      "pull":{
        "type":"ApiConnection",
        "inputs":{
          "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
          "path":"/listmessages","method":"post",
          "body":{"queueName":"@parameters('dlqName')","numberOfMessages":"@parameters('maxMessages')","visibilitytimeout":"PT2M"}
        }
      },
      "each":{
        "type":"Foreach",
        "foreach":"@coalesce(body('pull')?['QueueMessagesList']?['QueueMessage'], array())",
        "actions":{
          "decode":{"type":"Compose","inputs":"@json(base64ToString(item()?['MessageText']))"},
          "retries":{"type":"Compose","inputs":"@coalesce(outputs('decode')?['retryCount'],0)"},
          "if_poison":{
            "type":"If","expression":"@greater(outputs('retries'), parameters('maxRetries'))",
            "actions":{
              "to_poison":{
                "type":"ApiConnection",
                "inputs":{
                  "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
                  "path":"/putmessage","method":"post",
                  "body":{"queueName":"@parameters('poisonQueue')","content":"@base64(string(outputs('decode')))"}}
              }
            },
            "else":{
              "actions":{
                "inc":{"type":"Compose","inputs":"@union(outputs('decode'), json(concat('{\"retryCount\":', string(add(outputs('retries'),1)), '}')))"},
                "switch":{"type":"Switch","expression":"@parameters('mode')",
                  "cases":{
                    "requeue":{"actions":{
                      "to_main":{
                        "type":"ApiConnection",
                        "inputs":{
                          "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
                          "path":"/putmessage","method":"post",
                          "body":{"queueName":"@parameters('eventQueue')","content":"@base64(string(outputs('inc')))"}}
                      }
                    }},
                    "direct":{"actions":{
                      "invoke":{
                        "type":"Http",
                        "inputs":{
                          "method":"POST",
                          "uri":"@concat('https://management.azure.com/subscriptions/',parameters('subscriptionId'),'/resourceGroups/',parameters('resourceGroup'),'/providers/Microsoft.Synapse/workspaces/',parameters('synapseWorkspace'),'/pipelines/', coalesce(outputs('decode')?['pipelineName'],'pl_event_ingest'), '/createRun?api-version=2021-06-01')",
                          "body":{"isRecovery":false,"parameters":"@coalesce(outputs('decode')?['parameters'], json('{}'))"},
                          "authentication":{"type":"ManagedServiceIdentity","audience":"https://management.azure.com/"}
                        },
                        "retryPolicy":{"type":"exponential","interval":"PT5S","count":6}
                      }
                    }}
                  },
                  "default":{"actions":{}}
                }
              }
            }
          },
          "delete_from_dlq":{
            "type":"ApiConnection","runAfter":{"if_poison":["Succeeded"]},
            "inputs":{
              "host":{"connection":{"name":"@parameters('$connections')['azurequeues']['connectionId']"}},
              "path":"/deletemessage","method":"post",
              "body":{"queueName":"@parameters('dlqName')","messageid":"@item()?['MessageId']","popreceipt":"@item()?['PopReceipt']"}
            }
          }
        }
      }
    },
    "outputs":{}
  },
  "kind":"Stateful",
  "connections":{
    "azurequeues":{
      "connectionId":"/subscriptions/@appsetting('WORKFLOWS_SUBSCRIPTION_ID')/resourceGroups/@appsetting('WORKFLOWS_RESOURCE_GROUP_NAME')/providers/Microsoft.Web/connections/azurequeues",
      "connectionName":"azurequeues",
      "id":"/subscriptions/@appsetting('WORKFLOWS_SUBSCRIPTION_ID')/providers/Microsoft.Web/locations/@{workflow().location}/managedApis/azurequeues"
    }
  }
}